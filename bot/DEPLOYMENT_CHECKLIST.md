# 🚀 部署检查清单

## 📋 部署前检查

### 1. 环境要求 ✅
- [ ] **Python环境**：Python 3.7+ 已安装
- [ ] **包管理器**：pip 或 conda 可用
- [ ] **网络连接**：可访问Telegram API（api.telegram.org）
- [ ] **系统资源**：建议512MB以上内存，100MB以上磁盘空间
- [ ] **权限检查**：有读写当前目录的权限

### 2. 机器人配置 ✅
- [ ] **Bot Token**：已从 @BotFather 获取机器人Token
- [ ] **Token格式**：Token格式正确（数字:字母数字组合）
- [ ] **配置文件**：已在 `config.ini` 中设置正确的Token
- [ ] **Token验证**：Token未过期且有效

### 3. 管理员配置 ✅
- [ ] **用户ID获取**：已从 @userinfobot 获取所有管理员的用户ID
- [ ] **ID格式验证**：所有管理员ID都是有效的数字
- [ ] **配置文件**：已在 `config.ini` 中正确配置管理员
- [ ] **权限确认**：所有管理员都已启动过机器人

## 🔧 部署步骤

### 步骤1: 环境准备
```bash
# 检查Python版本
python3 --version

# 检查pip版本
pip3 --version

# 检查网络连接
ping api.telegram.org

# 检查目录权限
ls -la
```

### 步骤2: 安装依赖
```bash
# 进入项目目录
cd bot

# 升级pip（推荐）
pip3 install --upgrade pip

# 安装依赖包
pip3 install -r requirements.txt

# 验证安装
python3 -c "import telegram; print('依赖安装成功')"
```

### 步骤3: 配置验证
```bash
# 运行基础测试
python3 simple_test.py

# 检查配置文件格式
cat config.ini

# 验证管理员ID
python3 -c "
import configparser
config = configparser.ConfigParser()
config.read('config.ini')
for name, uid in config['ADMINS'].items():
    try:
        int(uid)
        print(f'✅ {name}: {uid}')
    except ValueError:
        print(f'❌ {name}: {uid} (无效ID)')
"
```

### 步骤4: 启动机器人
```bash
# 方式1: 直接启动（推荐用于测试）
python3 bot.py

# 方式2: 使用启动脚本（推荐用于生产）
./start.sh

# 方式3: 后台运行
nohup python3 bot.py > bot.log 2>&1 &

# 方式4: 使用systemd服务（Linux）
sudo systemctl start telegram-bot
sudo systemctl enable telegram-bot
```

## 🧪 功能测试

### 用户端测试
1. **启动测试**
   - [ ] 发送 `/start` 命令
   - [ ] 机器人响应并显示管理员选择界面
   - [ ] 按钮布局正确（3列网格）
   - [ ] 按钮文字显示完整

2. **选择管理员**
   - [ ] 点击任意管理员按钮
   - [ ] 机器人确认连接成功
   - [ ] 显示"请直接发送您的问题"提示
   - [ ] 按钮状态正确更新

3. **发送消息**
   - [ ] 发送任意文本消息
   - [ ] 机器人确认消息已发送给管理员
   - [ ] 消息内容正确转发
   - [ ] 无错误提示

### 管理员端测试
1. **接收通知**
   - [ ] 管理员收到新用户咨询通知
   - [ ] 通知包含用户信息（ID、用户名）
   - [ ] 显示"回复用户"按钮
   - [ ] 通知时间戳正确

2. **回复消息**
   - [ ] 点击"回复用户"按钮或直接回复
   - [ ] 机器人确认回复已发送
   - [ ] 用户收到标记为"客服回复"的消息
   - [ ] 回复内容完整

3. **会话管理**
   - [ ] 多个用户可同时咨询
   - [ ] 不同用户会话相互隔离
   - [ ] 超时会话自动关闭
   - [ ] 会话状态正确更新

## ⚠️ 常见问题排查

### 机器人无法启动
**症状**：运行 `python3 bot.py` 后立即退出
**排查步骤**：
```bash
# 1. 检查Python版本
python3 --version

# 2. 检查依赖安装
pip3 list | grep telegram

# 3. 检查配置文件
cat config.ini

# 4. 查看详细错误信息
python3 bot.py 2>&1 | tee error.log

# 5. 检查网络连接
curl -s https://api.telegram.org/bot$(grep token config.ini | cut -d'=' -f2 | tr -d ' ')/getMe
```

**常见解决方案**：
- Token格式错误：确保格式为 `数字:字母数字组合`
- 网络问题：检查防火墙和代理设置
- 权限问题：确保有读写目录权限
- 依赖缺失：重新安装依赖包

### 管理员收不到通知
**症状**：用户发送消息，管理员没有收到通知
**排查步骤**：
```bash
# 1. 验证管理员ID
python3 -c "
import configparser
config = configparser.ConfigParser()
config.read('config.ini')
print('管理员配置:')
for name, uid in config['ADMINS'].items():
    print(f'{name}: {uid}')
"

# 2. 检查机器人日志
tail -f bot.log | grep -i "admin"

# 3. 测试机器人API
curl -s "https://api.telegram.org/bot$(grep token config.ini | cut -d'=' -f2 | tr -d ' ')/getMe"
```

**常见解决方案**：
- 管理员ID错误：使用 @userinfobot 重新获取
- 机器人未启动：确保管理员已启动过机器人
- 网络问题：检查网络连接和防火墙
- API限制：检查机器人是否被限制

### 消息无法转发
**症状**：用户消息发送失败或无法转发
**排查步骤**：
```bash
# 1. 检查数据库状态
sqlite3 database.db "SELECT COUNT(*) FROM conversations WHERE status='active';"

# 2. 检查会话状态
sqlite3 database.db "SELECT * FROM conversations ORDER BY last_active DESC LIMIT 5;"

# 3. 查看错误日志
tail -f bot.log | grep -i "error\|fail"
```

**常见解决方案**：
- 会话过期：重新选择管理员
- 数据库问题：检查数据库文件权限
- 机器人重启：重新启动机器人
- 配置错误：检查配置文件格式

### 依赖安装失败
**症状**：`pip install` 命令失败
**排查步骤**：
```bash
# 1. 检查pip版本
pip3 --version

# 2. 检查Python版本
python3 --version

# 3. 尝试升级pip
pip3 install --upgrade pip

# 4. 使用国内镜像源
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# 5. 检查网络连接
ping pypi.org
```

**常见解决方案**：
- 网络问题：使用国内镜像源
- 权限问题：使用 `--user` 参数或sudo
- 版本兼容：检查Python版本要求
- 依赖冲突：创建虚拟环境

## 📊 性能监控

### 运行状态监控
- [ ] **机器人状态**：机器人正常运行，响应及时
- [ ] **日志输出**：日志输出正常，无错误信息
- [ ] **数据库操作**：数据库连接正常，操作流畅
- [ ] **网络连接**：与Telegram API连接稳定

### 会话管理监控
- [ ] **新会话创建**：新会话创建正常，无延迟
- [ ] **消息保存**：消息保存正常，无丢失
- [ ] **超时处理**：超时会话自动关闭，资源释放
- [ ] **并发处理**：多用户同时咨询无冲突

### 资源使用监控
- [ ] **内存使用**：内存使用稳定，无泄漏
- [ ] **CPU使用**：CPU使用合理，无异常峰值
- [ ] **磁盘空间**：数据库文件大小合理增长
- [ ] **网络带宽**：网络使用正常，无异常流量

## 🔒 安全检查

### 权限控制检查
- [ ] **管理员权限**：仅配置的管理员可回复
- [ ] **用户隔离**：用户会话相互隔离，无信息泄露
- [ ] **API访问**：机器人API访问受控
- [ ] **文件权限**：配置文件和数据库权限正确

### 数据保护检查
- [ ] **敏感信息**：电话号码等敏感信息自动脱敏
- [ ] **数据加密**：数据库文件权限安全
- [ ] **访问日志**：所有操作有日志记录
- [ ] **备份策略**：定期备份重要数据

### 网络安全检查
- [ ] **API安全**：使用HTTPS访问Telegram API
- [ ] **防火墙**：必要的网络端口开放
- [ ] **代理设置**：如使用代理，配置正确
- [ ] **DDoS防护**：基本的DDoS防护措施

## 📈 扩展建议

### 功能增强
- [ ] **消息统计**：添加消息数量和响应时间统计
- [ ] **多语言支持**：支持多种语言界面
- [ ] **文件传输**：支持图片、文档等文件传输
- [ ] **自动回复**：添加常用回复模板
- [ ] **工作时间**：设置工作时间和自动回复

### 运维优化
- [ ] **日志轮转**：配置日志文件轮转，避免文件过大
- [ ] **监控告警**：设置关键指标监控和告警
- [ ] **自动备份**：实现数据库自动备份
- [ ] **健康检查**：添加健康检查接口
- [ ] **性能调优**：根据使用情况优化性能

### 安全增强
- [ ] **访问控制**：实现更细粒度的权限控制
- [ ] **审计日志**：记录所有操作和访问
- [ ] **威胁检测**：检测异常访问和攻击行为
- [ ] **数据加密**：对敏感数据进行加密存储

## 🚨 紧急情况处理

### 机器人崩溃
1. **立即检查**：查看错误日志和系统状态
2. **重启服务**：使用启动脚本重新启动
3. **问题分析**：分析崩溃原因并修复
4. **监控恢复**：监控机器人恢复后的状态

### 数据丢失
1. **停止服务**：立即停止机器人避免数据进一步损坏
2. **备份恢复**：从最近的备份恢复数据
3. **问题定位**：找出数据丢失的原因
4. **预防措施**：加强备份和监控

### 安全事件
1. **隔离系统**：立即隔离受影响的系统
2. **事件分析**：分析安全事件的性质和影响
3. **修复漏洞**：修复发现的安全漏洞
4. **恢复服务**：在安全的前提下恢复服务

## 📞 技术支持

### 获取帮助的渠道
- [ ] **项目文档**：仔细阅读README和部署指南
- [ ] **测试脚本**：运行测试脚本诊断问题
- [ ] **日志分析**：查看详细日志信息
- [ ] **社区支持**：在相关社区寻求帮助
- [ ] **专业支持**：联系专业的技术支持团队

### 问题报告模板
```
**问题描述**：
[详细描述遇到的问题]

**环境信息**：
- 操作系统：
- Python版本：
- 依赖版本：
- 配置文件：

**错误信息**：
[粘贴完整的错误日志]

**复现步骤**：
[详细描述如何复现问题]

**期望结果**：
[描述期望的正确行为]
```

---

## 🎯 部署完成确认

当所有检查项都通过后，您的电报客服机器人就部署完成了！

**部署成功标志**：
- ✅ 机器人正常启动并运行
- ✅ 用户端功能测试通过
- ✅ 管理员端功能测试通过
- ✅ 性能监控指标正常
- ✅ 安全检查项目通过

**下一步建议**：
1. **邀请真实用户测试**：邀请朋友或同事测试功能
2. **监控运行状态**：持续监控机器人的运行状态
3. **收集用户反馈**：收集用户使用反馈并优化
4. **扩展功能模块**：根据需求添加更多功能
5. **建立运维体系**：建立完整的运维监控体系

**祝您使用愉快！** 🎉

如有问题，请参考故障排除指南或寻求技术支持。